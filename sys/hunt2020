server {
  listen 80;
  listen [::]:80;
  server_name pennypark.fun;
  rewrite ^ https://$server_name$request_uri? permanent;
}

upstream wait_proxy {
  ip_hash;
  keepalive 100;
  server unix:/run/sites/snellen_p0 fail_timeout=1s;
  server unix:/run/sites/snellen_p1 fail_timeout=1s;
  server unix:/run/sites/snellen_p2 fail_timeout=1s;
  server unix:/run/sites/snellen_p3 fail_timeout=1s;
  server unix:/run/sites/snellen_p4 fail_timeout=1s;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name pennypark.fun;

  include ssl_params_only;
  ssl_certificate /etc/letsencrypt/live/pennypark.fun/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/pennypark.fun/privkey.pem;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  location ~ ^/wait {
    proxy_pass http://wait_proxy;
    proxy_read_timeout 1h;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location ~ ^/art.* {
    proxy_pass http://unix:/run/sites/badart;
    proxy_read_timeout 1h;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location ~ ^/tug.* {
    proxy_pass http://unix:/run/sites/tugofwar;
    proxy_read_timeout 1h;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location ~ ^/tun.* {
    proxy_pass http://unix:/run/sites/tunnel_of_love;
    proxy_read_timeout 1h;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location ~ ^/hat.* {
    proxy_pass http://unix:/run/sites/hat_venn_dor;
    proxy_read_timeout 1h;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  location ~ ^/.well-known/ {
    root /sites/hunt2020/;
  }

  location ~ / {
    proxy_pass http://unix:/run/sites/snellen;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 3h;
  }
}